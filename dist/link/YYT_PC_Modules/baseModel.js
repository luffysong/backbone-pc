"use strict";var _win=window,Backbone=_win.Backbone;if(!Backbone)throw new Error("import Backbone");var Store=require("./store/locationStore"),Url=require("./util/url"),Config=require("config"),Tools=require("./util/tools"),warn=require("./util/warn"),uid=1314,expiration=Store.expiration,baseModelSort=[],BaseModel=Backbone.Model.extend({options:{},initialize:function(e){this._store={},this._view=null,this._onQueue=[],this._original=null,this.parameter=null,"function"==typeof this.beforeEmit&&this.beforeEmit(e),this._url=this.url,this.setEnv||this._ICESetEnv(),"string"==typeof this.url&&(this.url=this.url.split("?")[0],this.hostname=this.url)},_ICESetEnv:function(){var e=Config.env[Config.scheme];/^\{{0,2}(url_prefix)\}{0,2}/.test(this.url)&&(this.url=this.url.replace("{{url_prefix}}",e.url_prefix),this._url=this.url)},_ICESort:function(e,t){var r=e.length;if(2>r)return e;for(var s,i,o,n=0,a=n+1;a>n;n++)for(a=n+1;r>a;a++)s=t.call(this,e[n],e[a]),o=("number"==typeof s?s:s?1:0)>0,o&&(i=e[n],e[n]=e[a],e[a]=i);return e},_ICEOptions:function(){var e=this;return{beforeSend:function(t,r){for(var s in e.headers)t.setRequestHeader(s,e.headers[s])}}},_ICEFetch:function(e,t){var r=this,s=_.extend(this._ICEOptions(),this.options);this.fetch(_.extend({success:function(t,s){s=r._ICEProcessData(s),"function"==typeof e&&e.call(r,s)},error:function(e,s){"function"==typeof t&&t.call(r,s)}},s))},_ICESave:function(e,t,r){var s=this,i=_.extend(this._ICEOptions(),this.options);this.save(e,_.extend({success:function(e,r){r=s._ICEProcessData(r),"function"==typeof t&&t.call(s,r)},error:function(e,t){"function"==typeof r&&r.call(s,t)}},i))},_ICEDestroy:function(e,t){var r=this;this.destroy({success:function(t,s){"function"==typeof e&&e.call(r,s)},error:function(e,s){"function"==typeof t&&t.call(r,s)}})},_ICEJSONP:function(e,t){var r=this,s=$.ajax({url:this.url,data:this.parameter||{},dataType:"jsonp",jsonp:"callback"});s.done(function(t,s,i){t=r._ICEProcessData(t),"function"==typeof e&&e.call(r,t,s,i)}),s.fail(function(e,s,i){"function"==typeof t&&t.call(r,e,s,i)})},_ICESendHelper:function(e){var t=e.success,r=e.error;switch("GET"!==e.type&&(this.url=this.hostname),e.type){case"POST":this._ICESave(e.saveJSON,t,r);break;case"PUT":var s=e.saveJSON.id;s||0===s||(e.saveJSON.id="icepy"+uid++),this._ICESave(e.saveJSON,t,r);break;case"DELETE":this._ICEDestroy(t,r);break;case"JSONP":this._ICEJSONP(t,r);break;default:this._ICEFetch(t,r)}},_ICESendMessage:function(e){var t=this;if(this.storageCache&&this.expiration)if(Store.enabled){var r=expiration.get(this.url);if(!r)return this._ICESendHelper(e),!1;var s=e.success;"function"==typeof s&&setTimeout(function(){r=t._ICEProcessData(r,!0),s.call(t,r)},50)}else this._ICESendHelper(e);else this._ICESendHelper(e)},_ICEProcessData:function(e,t){return"function"==typeof this.formatter&&(e=this.formatter(e)),this.storageCache&&this.expiration&&!t&&Store.enabled&&expiration.set(this.url,e,this.expiration),this.$set(e),e},execute:function(e,t){var r={type:"GET",success:e,error:t};this._ICESendMessage(r)},executeGET:function(e,t){var r={type:"GET",success:e,error:t};this._ICESendMessage(r)},executePOST:function(e,t,r){var s={type:"POST",saveJSON:e,success:t,error:r};this._ICESendMessage(s)},executePUT:function(e,t,r){var s={type:"PUT",saveJSON:e,success:t,error:r};this._ICESendMessage(s)},executeDELETE:function(){var e={type:"DELETE",success:success,error:error};this._ICESendMessage(e)},executeJSONP:function(e,t,r){this.parameter=null,this.parameter=e;var s={type:"JSONP",success:t,error:r};this._ICESendMessage(s)},setChangeURL:function(e){var t="";if(e){for(var r in e){var s=e[r];t=t.length?t.replace("{{"+r+"}}",s):this._url.replace("{{"+r+"}}",s)}this.url=t}},setHeaders:function(e){this.headers=null,this.headers=e},setView:function(e){this._view=e},setOnQueueKeys:function(e){"[object Array]"!==Tools.toType(e)||(this._onQueue.length=0,this._onQueue=e)},$get:function(e){if(!e)return this._store;var t=e.split("."),r=t.length;if(r>0){for(var s=t[0],i=0,o=this._store;s;)i++,o=o[s],s=t[i];return o}},$set:function(e,t,r){if(null==e)return this;if(Tools.isPlainObject(e))return this._store=null,this._store=e,this.set(this._store),!1;var s=e.split("."),i=s.length;if(i>0){var o=0,n=s[o],a=this._store;if(1!==i)for(;n&&(o++,a=a[n],n=s[o],!(o>i-2)););switch(Tools.toType(a)){case"[object Object]":a[n]=t;break;case"[object Array]":a[Tools.exportToNumber(n)]=t;break;default:a=t}}},$filter:function(e,t){var r=this.$get(e),s=[];if("[object Array]"===Tools.toType(r))for(var i,o=r.length;o--;){var n=r[o];switch(Tools.toType(t)){case"[object Object]":i=!0;for(var a in t)if(n[a]!==t[a]){i=null;break}break;case"[object Function]":i=t(n,o);break;default:i=n===t}i&&s.push(n)}return s},$sort:function(e,t){var r=this.$get(e);if(baseModelSort.length=0,"[object Array]"===Tools.toType(r))switch(Tools.toType(t)){case"[object Function]":baseModelSort=this._ICESort(r,t);break;default:if("string"==typeof t){var s=t.split("."),i=null,o=s.length-1;switch(s[o]){case">":i=!0;break;case"<":i=!1;break;default:return baseModelSort}if(null!==i)return this._ICESort(r,function(e,t){for(var r=s[0],n=0;r&&(e=e[r],t=t[r],n++,n!==o);)r=s[n];return i?e>t:t>e})}}return baseModelSort},$updateStore:function(){Store.enabled&&expiration.set(self.url,this._store,self.expiration)}});module.exports=BaseModel;