"use strict";var BaseModel=require("BaseModel"),Dialog=require("ui.Dialog"),LoginBox=require("LoginBox"),cookie=require("cookie"),Config=require("config"),domains=Config.domains,checkEmailTemplate=require("./template/email.html"),checkEmailHTML=checkEmailTemplate.replace("{homeSite}",domains.homeSite),loginbox=LoginBox().dialog,CheckVIPModel=BaseModel.extend({url:"http://vip.yinyuetai.com/vip/check-vip",setEnv:!0,beforeEmit:function(){}}),FetchUserInfoForDB=BaseModel.extend({url:domains.loginSite+"/login-info",setEnv:!0,beforeEmit:function(){}}),UserModel=BaseModel.extend({setEnv:!0,beforeEmit:function(e){this.checkVIPModel=new CheckVIPModel,this.fetchUserInfoForDBModel=new FetchUserInfoForDB},isLogined:function(){return!!this.getToken()},login:function(e,i){var o=this;this.isLogined()?e.call(this):(this.on("login",e),loginbox.trigger("show"),loginbox.once("hide",function(){o.off("login"),i&&i()}))},getUserInfo:function(e,i){if(this.isLogined()){var o,t=this,n=function(){return"function"==typeof e?t.$get():t.$get(e)},r=this.$get("isEmailVerified");i||(i=e),r?"function"==typeof i&&(o=n(),i.call(this,o)):this.fetchUserInfo(function(){"function"==typeof i&&(o=n(),i.call(t,o))})}},checkUserEmail:function(e){var i=this;this.getUserInfo("isEmailVerified",function(o){o?"function"==typeof e&&e.call(i):Dialog.classInstanceDialog(checkEmailHTML,{title:"邮箱验证",width:400,height:100,isAutoShow:!0})})},checkUserVIP:function(e,i){var o=this;if(this.isLogined())this.login(function(){o.fetchVIPInfo(e,i)});else{var t=this.$get("vipInfo");t?t&&!t.error&&t.realVip&&~~t.realVip>0?e(t):cancel():this.fetchVIPInfo(e,i)}},emit:function(){var e=this.getToken(),i=cookie.get("u_inf");e&&(i&&i.length>0?this.readUserInfoForCookie(i):this.fetchUserInfo())},isVIPUser:function(){var e=cookie.get("token");if(e){var i=e.split(".");if(i.length>2){var o=i[2];return~~o[0]>0}}return!1},readUserInfoForCookie:function(e){var i=String.fromCharCode(2);e=decodeURIComponent(e);var o=e.split(i);this.$set({userId:~~o[0],userName:o[1],bigheadImg:o[4]})},fetchUserInfo:function(e){var i=this;this.fetchUserInfoForDBModel.executeJSONP(function(o){i.$set(o),"function"==typeof e&&e.call(i)},function(o){"function"==typeof e&&e.call(i,o)})},fetchVIPInfo:function(e,i){var o=this;this.checkVIPModel.executeJSONP(function(i){i&&!i.error&&(i.realVip&&parseInt(i.realVip)>0||i.isWo)&&(o.set("vipInfo",i),"function"==typeof e&&e.call(o,i))},function(e){"function"==typeof i&&i.call(o,e)})},getToken:function(){return cookie.get("token")},getUserId:function(){return this.$get("userId")}}),shared=null;UserModel.sharedInstanceUserModel=function(){return shared||(shared=new UserModel,shared.on("change:userId",function(){shared.trigger("login")}),shared.emit()),shared},module.exports=UserModel;