"use strict";function _initForm(){errorinfo=loginBoxForm.find(".errorinfo"),email=loginBoxForm.find("[name=email]"),password=loginBoxForm.find(".pwd"),_setFocusEffect(email),_setFocusEffect(password);var e=require("UserModel");user=e.sharedInstanceUserModel(),ajaxForm=AjaxForm.classInstanceAjaxForm(loginBoxForm,{success:function(){var e=this.contentWindow,r=(e.location,decodeURIComponent(e.location.search)),i=url.parseSearch(r);i=i.json,i.error?(errorinfo.text(i.message).css("visibility","visible"),refreshGeetest()):i.platFormRef?location.href="http://login.yinyuetai.com/platform":(user.$set(i),dialog.trigger("hide"))},failure:function(){}})}function _setFocusEffect(e){"email"===e.attr("name")?(e.focus(function(){$(this).parent().addClass("emailfocus").removeClass("emailerror")}),e.blur(function(){$(this).parent().removeClass("emailfocus")})):(e.focus(function(){$(this).parent().addClass("focus").removeClass("error")}),e.blur(function(){$(this).parent().removeClass("focus")}))}function cryptoParam(){return[$.trim(email.val())+$.trim(password.val())]}function loginSubmit(e){e.preventDefault();var r=cryptoParam();ajaxForm.encrypto(secret.apply(window,r)),isPassTest()&&(ajaxForm.setIframeState(!0),this.submit())}function refreshGeetest(){Geetest.refresh(),isGeetest=!1}function validator(){var e=$.trim(email.val()),r=$.trim(password.val());if(0===e.length)return errorinfo.text("邮箱或手机不能为空").css("visibility","visible"),email.parent().addClass("emailerror"),!1;if(!EMAIL_PATTERN.test(e)){if(!NUMBER_PATTERN.test(e))return errorinfo.text("请输入正确的电子邮箱或手机").css("visibility","visible"),email.parent().addClass("emailerror"),!1;if(11!==e.length)return errorinfo.text("请输入正确的电子邮箱或手机").css("visibility","visible"),email.parent().addClass("emailerror"),!1}return 0===r.length?(errorinfo.text("密码不能为空").css("visibility","visible"),password.parent().addClass("error"),!1):r.length<4||r.length>20?(errorinfo.text("密码长度必须大于4且小于20").css("visibility","visible"),password.parent().addClass("error"),!1):!0}function isPassTest(){if(!validator())return refreshGeetest(),!1;if(!isGeetest){var e="拖动滑块完成验证";return errorinfo.text(e).css("visibility","visible"),!1}return 0!=loginBoxForm.find("[name=encpsw]").length?loginBoxForm.find("[name=encpsw]").val(pwdencrypt(password.val())):$("<input />").attr({type:"hidden",name:"encpsw",value:pwdencrypt(password.val())}).appendTo(loginBoxForm),!0}function compileHTML(e,r){return tplEng.compile(e)(r)}var Dialog=require("ui.Dialog"),AjaxForm=require("AjaxForm"),pwdencrypt=require("pwdencrypt"),url=require("url"),loginBoxTemp=require("./template/loginBox.html"),tplEng=require("tplEng"),secret=require("secret"),EMAIL_PATTERN=/^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,NUMBER_PATTERN=/^[+-]?[1-9][0-9]*(\.[0-9]+)?([eE][+-][1-9][0-9]*)?$|^[+-]?0?\.[0-9]+([eE][+-][1-9][0-9]*)?$/,isGeetest=!1,Geetest,errorinfo,email,password,loginBoxForm,ajaxForm,dialog,requrest=!0,user;window.gt_custom_ajax=function(e,r){if(e){isGeetest=!0;var i=loginBoxForm.find(".errorinfo");"拖动滑块完成验证"==i.html()&&i.css("visibility","hidden")}},module.exports=function(){if(!dialog){var e=compileHTML(loginBoxTemp,{url:"http://login.yinyuetai.com"});dialog=Dialog.classInstanceDialog(e,{width:691,height:342,isRemoveAfterHide:!1,isAutoShow:!1}),loginBoxForm=dialog.$el.find("#loginBoxForm"),dialog.on("show",function(){Geetest||(Geetest=new window.Geetest({gt:"cc34bd7df5c42f7d9c3f540fdfb671cf",product:"float"}),Geetest.appendTo("#captcha")),_initForm(),$.getJSON("http://www.yinyuetai.com/partner/get-partner-code?placeIds=reg_window&callback=?",function(e){e&&e.reg_window&&self.dialog.$el.find(".loginbox-placehold").html(e.reg_window)})}),dialog.on("hide",function(){var e=dialog.$el.find("form");e.find(".errorinfo").css("visibility","hidden"),e.find("[name=email],[name=password]").parent().removeClass("emailerror").removeClass("error"),$(".J_pop_download").removeClass("v_button_curv"),setTimeout(function(){refreshGeetest()},500)}),loginBoxForm.on("submit",loginSubmit)}return{dialog:dialog}};