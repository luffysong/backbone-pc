"use strict";var BaseView=require("BaseView"),UploadFile=require("UploadFile"),uploadIng="正在上传",uploadDone="上传完成!",MsgBox=require("ui.MsgBox"),loc=window.location,View=BaseView.extend({rawLoader:function(){},events:{"click .submit":"saveHandler","change .upload-file":"changeFile"},beforeMount:function(){},afterMount:function(){this.formDOM=this.$el.find(".upload-form"),this.imgSrcDOM=this.$el.find(".imgboxFile"),this.imageStateDOM=this.$el.find(".upload-image-state"),this.inputTextDOM=this.$el.find(".input-text")},ready:function(e){var i=e.ctrlData||{cmd:[{saveOriginal:1,op:"save",plan:"avatar",belongId:"20634338",srcImg:"img"}],redirect:loc.origin+"/web/upload.html"},t=this;this.upload=UploadFile.classInstanceUploadFile({el:this.formDOM,url:"http://image.yinyuetai.com/edit",data:i,filename:"img",className:"file",success:function(e){t.imageStateDOM.html(uploadDone),t.previewImage(e),t.trigger("uploadFileSuccess",e)},failure:function(){MsgBox.showError("上传失败")}}),this.on("successBreviary",function(e){this.successBreviary(e)})},successBreviary:function(e){this.emptyValue(),e.breviaryUrl&&(this.imgSrcDOM.attr("src",e.breviaryUrl),this.imgSrcDOM.show()),e.inputText&&this.inputTextDOM.text(e.inputText)},saveHandler:function(e){this.trigger("saveFile")},changeFile:function(e){this.imageStateDOM.html(uploadIng),this.upload.submit()},previewImage:function(e){var i=e.images;if(i&&i.length>0){var t=i[0].path;this.imgSrcDOM.attr("src",t),this.imgSrcDOM.show()}},emptyValue:function(){this.imageStateDOM.html(""),this.imgSrcDOM.hide(),this.inputTextDOM.text("上传图片")}}),shared=null;View.sharedInstanceUploadFileDialog=function(e){return shared||(shared=new View(e)),shared},View.fetchDialogTemplate=function(){return require("./template/fileDialog.html")},module.exports=View;